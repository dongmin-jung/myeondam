# HyperCloud 생체인증

---

- FIDO 란?
  - Fast IDentity Online
  - 어원은 라틴어 동사 fido - trust, rely upon, put confidence in 이라는 뜻, 링컨 대통령의 반려견 이름
  - 생체인증과 동의어처럼 많이 사용되지만, FIDO가 곧 생체인증인 것은 아님
  - FIDO 인증은, 사용자 단말에서 사용자 확인 후, 전자서명된 값을 서버로 보내 인증을 수행하는 방식을 말함
    - 사용자 확인 - 특별한 USB 보유여부, 생체정보, PIN번호 등
    - PIN이면 패스워드와 다를 바?
      - FIDO 인증시, 사용자 확인에 사용된 정보는 인증장치를 떠나지 않음
      - PIN을 아는 것으로는 충분하지 않고, PIN을 통해 등록한 바로 그 인증장치로 인증해야만 함
  - 등장배경 - Password의 한계
    - 불편함
      - 온갖 사이트마다 다 다른 정책 → 기억하기 어렵고 번거로움
    - 보안이 약함
      - 재사용 → 하나 뚫리면 다 털림 (구글 비번 털린 실제 경험 - 이집트, 중국, 대만)
      - 서버를 가장한 제3자에게 비밀번호를 털리기도 쉬움 (중고나라 안전결제 네이버페이)
      - 한 사이트의 서버 DB가 털리면 다른 사이트의 계정들도 위험해짐
    - FIDO 인증은 위 문제들을 모두 극복
      - 생체인증은 기억력에 의존하지 않음
      - challenge-response 방식이어서, 해커가 중도에 인증 데이터를 가로채더라도 재사용 불가
      - 서버에는 공개키만 보관되므로, 해커가 서버 DB를 털어도 로그인이나 부정사용 불가
      - localhost/https로 제공되는 서비스만 허용하고, 서비스-specific key pair를 사용하고, 등록/인증 과정에서 URL 도메인을 확인함
        - 네이버페이 사기 케이스를 생각하자면, https가 아닐테니 애초에 사용이 불가능하기도 하지만,
        - 네이버페이 사기 사이트에 등록/인증하더라도 그 키가 실제 네이버에 등록된 키와 아무 상관이 없음
      - 사족
        - 물리적 외압이나 국가를 상대로는 덜 안전할 수 있음 - 묵비권(진술거부권) 보호X
        - 바꿀 수 있는 Password와 달리 생체정보는 바꿀 수 없으니, 위조를 판별해낼 수 있게 인식기술이 계속 발전해야 함

---

- FIDO 역사
  - 2012년 FIDO Alliance 설립
    - 편리하고 강력한 보안, password 없고 궁극적으로는 ID도 없는 세상
    - 회원사
      - 구글, 마소, 아마존, 페북 / 애플, 레노버, 인텔 / 비자, 마스터, 비씨, 페이팔 / 삼성, 라인, 라온시큐어 ...
      - 이상은 보드레벨의 일부, 스폰서레벨은 훨씬 많음
  - 2014년 12월 FIDO 1.0 표준 - UAF & U2F
    - UAF (Universal Authentication Framework) - 모바일 앱
      - 모바일 기기의 빌트인 인증장치를 사용하여 앱 서버에의 인증을 수행하는 데 사용되는 표준
      - 예시 - 은행 앱 로그인, 삼성페이 결제 등
    - U2F (Universal 2nd Factor) - 2nd Factor로만 사용
      - ID/PW에 추가적인 인증수단을 등록하여 보안을 강화하는 것
      - 특수한 인증장치 필요 (USB Security Key)
      - 예시 - Google 계정에서 옵션 활성화
  - 2019년 3월 FIDO2 표준 (WebAuthn & CTAP) - 브라우저
    - WebAuthn (Web Authentication)
      - W3C 표준이 되어 주요 브라우저에 내장 API가 추가됨 (Windows, Android, Mac / Chrome, Edge, FireFox)
        - 추가적으로 확인해본 브라우저
          - Windows - Opera, Brave, Whale
          - Ubuntu 20.04 LTS - FireFox
        - IE에서는 안됨
      - 정확히는 브라우저의 Credential Management API에 store/get 외에 create가 추가된 것
    - CTAP (Client To Authenticator Protocol)
      - 플랫폼(브라우저+OS)이 인증장치와 소통하는 데 사용되는 프로토콜
      - 플랫폼에서 USB/NFC/블루투스로 연결된 인증장치를 찾고, 특성을 알아내고, 사용자 등록/인증을 시도하고, 인증장치가 응답 데이터나 에러를 반환

---

- FIDO 등록/인증 동작 방식
  - 등록 - credential key pair를 생성하고, 공개키를 FIDO 서버에 등록하는 절차
    - 클라이언트에서 서버에 등록을 요청하면, 서버가 인증장치에 챌린지와 추가적인 매개변수를 보낸다.
      - 추가적인 매개변수란 RP Name/ID(domain), 유저 Name/ID, 지원하는 암호화의 종류, 그외 선택적 정보들
      - 클라이언트에서 서버 응답으로 받은 저 정보들을 가지고, WebAuthn API 요청
      - 브라우저에서 WebAuthn API가 불리면 플랫폼(OS와 브라우저)가 인증장치와 CTAP으로 통신 시작
    - 인증장치는 user verification이나 user presence를 체크하고, 새로운 key pair와 attestation을 생성
    - 인증장치는 공개키와 attestation으로 assertion을 생성하고 개인키로 서명하여 서버로 전송
    - 서버는 서명을 확인하여 assertion을 검증하고, 공개키를 저장한다.
  - 인증 - 사용자의 로그인/거래요청 시
    - 거의 비슷한데, 인증장치는 attestation 없이 assertion을 생성, 개인키로 서명해서 서버로 보내고, 서버는 공개키로 이를 검증
  - Keycloak, Windows, Chrome, Windows Hello, IR Camera 예시 설명

---

- 인증장치에 대한 설명, 얼굴/지문인식 과정
  - 하드웨어 인증장치 - secure key store라는, 사용자 정보와 개인키를 저장할 '안전한 공간'을 가지고 있어야 하고, 새로운 key pair를 계속 만들어낼 수 있어야 함
  - 소프트웨어 인증장치 - Windows Hello 같은 것 - 얼굴인식/지문인식/PIN을 등록해두고 택1하여 인증
    - 지문인식 - 발전은 있으나, 기본 골자는 20년 넘게 유지되고 있음
      - 지문인식장치는 광학식(회사출입문)/초음파방식(온스크린)/정전용량식(그외대부분)
      - 특징점을 추출하여 비교 → 유사도가 threshold를 넘는지 판단
        - 특징점 - 끝점(융선이 끊어지는 지점 - 막다른 길), 분기점(융선이 갈라지는 지점 - 삼거리), 중심점(융선의 굴곡이 가장 큰 지점 - 정수리), 삼각지(융선 3개가 모이는 부분)
      - 특징점 추출을 위한 처리들
        - image enhancement - 필터 사용하여 노이즈를 줄임
        - binarize - 그레이 스케일에서 흑과 백의 이진으로
        - smooth - 거칠게 인식된 융선을 부드럽게
        - thin - 융선의 폭을 픽셀 하나로 줄임
        - 의사특징점 제거 - 원형, 삼각형, 다리, 십자가 형태 제거
          - 상처로 끊긴 융선이나 압착에 의한 변형을 보정
      - ubuntu 20.04 LTS부터 빌트인으로 지원되는 지문인식에는 BOZORTH3 알고리즘 사용 (FBI에서 만들고 NIST에서 수정)
    - 얼굴인식
      - Windows Hello가 얼굴을 인식하는 과정
        - 적외선 카메라 필요 - 조명과 관계없이 일정한 흑백이미지로 input control (일반 카메라 X)
        - 얼굴개수1개 → 얼굴각도15도이내 → 주요지점(눈코입 등 landmark/alignment points) 명암차 수치로 representation vector 수천개 생성 (이미지 저장X) → 저장된 representation과의 유사도가 threshold 넘는지 봄
        - 내가 시도하면 95%↑ / 5%↓, 남이 시도하면 1/10만↓, 일란성 쌍둥이도 구별
        - 보안 문제로 이 이상은 비공개
      - Debian/Ubuntu에서 Windows Hello 스타일의 얼굴인식 로그인을 지원하기 위해 만들어진 오픈소스 Howdy는 dlib C++ 라이브러리(github 즐겨찾기 1만 / k8s가 7만)에서 가져온 모델을 사용함
        - 인용수 6만짜리 2016년 논문 Residual Network(ILSVRC 2015 image classification 분야 1위, 다른 2개 대회에서도 지원 분야 우승)의 34레이어 짜리에서 레이어 수와 필터 수를 줄이고 7500명의 3백만 개 얼굴로 훈련

---

- Keycloak에서의 지원 현황
  - webauthn4j ('j'ava? 'j'apan?) Library 쪽에서 Keycloak 플러그인 형태로 개발해오던 것이, Keycloak으로의 pull request가 merge되었고, 2019년 11월의 Keycloak 8.0.0 부터 passwordless, 2-factor 등록/인증 지원 시작
  - 직접 구축하여 테스트 완료하였으나, 지금은 최소한의 기능만 제공되고 있음
    - 한계 - 키 등록 시점이 '첫 로그인 시점'으로 강제됨 + 추후 조회/추가/삭제 불가
    - 추후에 자기 계정 관리 화면에서 키 등록/조회/추가/삭제 지원할 계획이라 함
      - 지금과 UI가 완전히 달라질 수도 있고, 기존에 등록해놓은 사용자 데이터가 보존되지 않을 수 있다고 함
  - 지금 HyperCloud에서 활성화할 수 없는 이유
    - 가입/로그인 시점에 키를 등록해야 하므로 모든 사용자에게 키 등록이 강제되고, 키 등록을 원치 않는 사용자나 IE를 쓰는 사용자에게는 좋지 않을 것
    - 키를 추가/삭제할 수 없으므로 최초 등록한 키를 항상 가지고 있어야 함 (패스워드로 로그인하거나 관리자가 직접 키 지워줄 수 있긴 함)

---

- 결론
  - FIDO2는 아직 대중화되지 않았음. 생체인증은 모바일 앱이나 윈도우 로그인에만 많이 쓰이는 중. 심지어 구글에서 "naver fido2" 검색하면 티맥스블로그가 맨 위에 나옴
  - 그러나 분명 웹에서도 생체정보 기반 인증은 점점 더 많이 사용될 것임
    - 중저가 랩탑에도 점점 '지문인식장치나 적외선카메라 중 적어도 하나'가 탑재된 기종이 많아지는 추세
    - Ubuntu도 20.04 LTS부터 지문인식 로그인을 빌트인으로 지원 (얼굴인식 로그인은 오픈소스 앱 howdy 필요)
    - 공인인증서 사용 의무화 폐지 이후 스마트폰 금융 앱에서 생체인증이 많이 활성화됨 → Why not 인터넷 뱅킹?
  - 지금 지원되는 곳이 적은 이유는, 아직 하드웨어 보급이 덜 되었고, FIDO2가 표준이 된 지 얼마 안 되어서가 아닐까?
  - 더 많은 기기/OS/브라우저가 FIDO2를 지원하고, 더 많은 서비스 제공자들과 사용자들에게 쓰이기 시작할 때면, Keycloak에서의 지원도 개선되어 있지 않을까?
  - HyperCloud 생체인증도, Keycloak 의 FIDO2 지원 확대와 함께 지원하면 어떨까?
  